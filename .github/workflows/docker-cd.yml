name: Deploy to KinD Cluster with Kyverno

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    # -------------------------------------------------
    # 1Ô∏è‚É£ Checkout Repository
    # -------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v3


    # -------------------------------------------------
    # 2Ô∏è‚É£ Kyverno Policy Validation (Shift-Left)
    #    Using Docker CLI Image
    # -------------------------------------------------
    - name: Validate Manifests with Kyverno
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workdir \
          ghcr.io/kyverno/kyverno-cli:v1.12.5 \
          kyverno apply policies/ -r manifests/


    # -------------------------------------------------
    # 3Ô∏è‚É£ Create KinD Cluster
    # -------------------------------------------------
    - name: Set up KinD Cluster
      uses: helm/kind-action@v1.4.0
      with:
        version: v0.20.0
        cluster_name: kyverno-demo


    # -------------------------------------------------
    # 4Ô∏è‚É£ Verify Cluster
    # -------------------------------------------------
    - name: Cluster Info
      run: |
        kubectl cluster-info
        kubectl get nodes


    # -------------------------------------------------
    # 5Ô∏è‚É£ Install Kyverno Controller in Cluster
    # -------------------------------------------------
    - name: Install Kyverno Admission Controller
      run: |
        kubectl create -f https://raw.githubusercontent.com/kyverno/kyverno/main/config/release/install.yaml

        echo "Waiting for Kyverno pods..."
        kubectl wait \
          --for=condition=available \
          deployment/kyverno-admission-controller \
          -n kyverno \
          --timeout=180s


    # -------------------------------------------------
    # 6Ô∏è‚É£ Apply Kyverno Policies
    # -------------------------------------------------
    - name: Apply Cluster Policies
      run: |
        kubectl apply -f policies/


    # -------------------------------------------------
    # 7Ô∏è‚É£ Deploy Application Manifests
    # -------------------------------------------------
    - name: Deploy Application
      run: |
        kubectl apply -f manifests/


    # -------------------------------------------------
    # 8Ô∏è‚É£ Wait for Pod Readiness
    # -------------------------------------------------
    - name: Wait for Pods
      run: |
        kubectl wait \
          --for=condition=ready pod \
          -l app=guestbook-ui \
          --timeout=180s


    # -------------------------------------------------
    # 9Ô∏è‚É£ Port Forward Service
    # -------------------------------------------------
    - name: Port Forward Service
      run: |
        nohup kubectl port-forward service/guestbook-ui 8080:8010 &
        sleep 20


    # -------------------------------------------------
    # üîü Test Application Access
    # -------------------------------------------------
    - name: Test Application
      run: |
        curl http://localhost:8080
