name: Deploy to KinD Cluster

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    # -------------------------------------------------
    # 1Ô∏è‚É£ Checkout repository
    # -------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3


    # -------------------------------------------------
    # 2Ô∏è‚É£ Install Kyverno CLI (Shift-Left Policy Check)
    # -------------------------------------------------
    - name: Install Kyverno CLI
      run: |
        curl -s https://raw.githubusercontent.com/kyverno/kyverno/main/scripts/install-cli.sh | bash
        sudo mv kyverno /usr/local/bin/
        kyverno version


    # -------------------------------------------------
    # 3Ô∏è‚É£ Validate Kubernetes manifests against policies
    # -------------------------------------------------
    - name: Kyverno Policy Validation
      run: |
        kyverno apply policies/ -r manifests/


    # -------------------------------------------------
    # 4Ô∏è‚É£ Create KinD Cluster
    # -------------------------------------------------
    - name: Set up KinD cluster
      uses: helm/kind-action@v1.4.0
      with:
        version: v0.20.0
        cluster_name: kyverno-demo


    # -------------------------------------------------
    # 5Ô∏è‚É£ Verify cluster access
    # -------------------------------------------------
    - name: Cluster Info
      run: |
        kubectl cluster-info
        kubectl get nodes


    # -------------------------------------------------
    # 6Ô∏è‚É£ Install Kyverno in the cluster
    # -------------------------------------------------
    - name: Install Kyverno Controller
      run: |
        kubectl create -f https://raw.githubusercontent.com/kyverno/kyverno/main/config/release/install.yaml

        echo "Waiting for Kyverno pods..."
        kubectl wait --for=condition=available deployment -n kyverno kyverno-admission-controller --timeout=120s


    # -------------------------------------------------
    # 7Ô∏è‚É£ Apply Kyverno Policies to cluster
    # -------------------------------------------------
    - name: Apply Kyverno Policies
      run: |
        kubectl apply -f policies/


    # -------------------------------------------------
    # 8Ô∏è‚É£ Deploy Application Manifests
    # -------------------------------------------------
    - name: Deploy Application
      run: |
        kubectl apply -f manifests/


    # -------------------------------------------------
    # 9Ô∏è‚É£ Wait for Pod Readiness
    # -------------------------------------------------
    - name: Wait for Pod Readiness
      run: |
        kubectl wait --for=condition=ready pod -l app=guestbook-ui --timeout=120s


    # -------------------------------------------------
    # üîü Port Forward Service
    # -------------------------------------------------
    - name: Port Forward Service
      run: |
        nohup kubectl port-forward service/guestbook-ui 8080:8010 &
        sleep 15


    # -------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ Test Application
    # -------------------------------------------------
    - name: Test Application Access
      run: |
        curl http://localhost:8080
