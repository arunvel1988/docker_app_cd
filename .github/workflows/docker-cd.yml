name: Deploy to KinD Cluster

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Install Kyverno CLI
      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/latest/download/kyverno-cli_linux_x86_64.tar.gz
          tar -xvf kyverno-cli_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/

      # 3. Validate manifests against policies
      - name: Kyverno policy validation
        run: |
          kyverno apply policies/ -r .

      # 4. Set up KinD
      - name: Set up KinD cluster
        uses: helm/kind-action@v1.4.0
        with:
          version: v0.20.0

      # 5. Cluster check
      - name: Configure kubectl
        run: |
          kubectl cluster-info
          kubectl get nodes

      # 6. Deploy
      - name: Deploy application
        run: |
          kubectl apply -f .

      # 7. Wait for pod
      - name: Wait for pod readiness
        run: |
          kubectl wait --for=condition=ready pod -l app=guestbook-ui --timeout=30s
